use crate::*;

// Contains additional AVCC fields that seem to be somewhat optional.
#[test]
fn avcc_ext() {
    const ENCODED: &[u8] = &[
        0x00, 0x00, 0x00, 0x1C, 0x66, 0x74, 0x79, 0x70, 0x69, 0x73, 0x6F, 0x36, 0x00, 0x00, 0x02,
        0x00, 0x69, 0x73, 0x6F, 0x36, 0x63, 0x6D, 0x66, 0x63, 0x6D, 0x70, 0x34, 0x31, 0x00, 0x00,
        0x05, 0x05, 0x6D, 0x6F, 0x6F, 0x76, 0x00, 0x00, 0x00, 0x6C, 0x6D, 0x76, 0x68, 0x64, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0xE8,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x02, 0x23, 0x74, 0x72,
        0x61, 0x6B, 0x00, 0x00, 0x00, 0x5C, 0x74, 0x6B, 0x68, 0x64, 0x00, 0x00, 0x00, 0x03, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x40, 0x00, 0x00, 0x00, 0x05, 0x00, 0x00, 0x00,
        0x02, 0xD0, 0x00, 0x00, 0x00, 0x00, 0x01, 0xBF, 0x6D, 0x64, 0x69, 0x61, 0x00, 0x00, 0x00,
        0x20, 0x6D, 0x64, 0x68, 0x64, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x3C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x55, 0xC4, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x36, 0x68, 0x64, 0x6C, 0x72, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x76, 0x69, 0x64, 0x65, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x4C, 0x2D, 0x53, 0x4D, 0x41, 0x53, 0x48, 0x20, 0x56, 0x69, 0x64, 0x65, 0x6F, 0x20,
        0x48, 0x61, 0x6E, 0x64, 0x6C, 0x65, 0x72, 0x00, 0x00, 0x00, 0x01, 0x61, 0x6D, 0x69, 0x6E,
        0x66, 0x00, 0x00, 0x00, 0x14, 0x76, 0x6D, 0x68, 0x64, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x24, 0x64, 0x69, 0x6E, 0x66, 0x00,
        0x00, 0x00, 0x1C, 0x64, 0x72, 0x65, 0x66, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
        0x00, 0x00, 0x00, 0x0C, 0x75, 0x72, 0x6C, 0x20, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x01,
        0x21, 0x73, 0x74, 0x62, 0x6C, 0x00, 0x00, 0x00, 0xD5, 0x73, 0x74, 0x73, 0x64, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0xC5, 0x61, 0x76, 0x63, 0x31, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x05, 0x00, 0x02, 0xD0, 0x00, 0x48, 0x00,
        0x00, 0x00, 0x48, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x0A, 0x41, 0x56, 0x43,
        0x20, 0x43, 0x6F, 0x64, 0x69, 0x6E, 0x67, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x18,
        0xFF, 0xFF, 0x00, 0x00, 0x00, 0x38, 0x61, 0x76, 0x63, 0x43, 0x01, 0x64, 0x00, 0x1F, 0xFF,
        0xE1, 0x00, 0x1C, 0x67, 0x64, 0x00, 0x1F, 0xAC, 0xD9, 0x80, 0x50, 0x05, 0xBB, 0x01, 0x6A,
        0x02, 0x02, 0x02, 0x80, 0x00, 0x00, 0x03, 0x00, 0x80, 0x00, 0x00, 0x1E, 0x07, 0x8C, 0x18,
        0xCD, 0x01, 0x00, 0x05, 0x68, 0xE9, 0x7B, 0x2C, 0x8B, 0xFD, 0xF8, 0xF8, 0x00, 0x00, 0x00,
        0x00, 0x13, 0x63, 0x6F, 0x6C, 0x72, 0x6E, 0x63, 0x6C, 0x78, 0x00, 0x01, 0x00, 0x01, 0x00,
        0x01, 0x00, 0x00, 0x00, 0x00, 0x10, 0x70, 0x61, 0x73, 0x70, 0x00, 0x00, 0x00, 0x01, 0x00,
        0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x14, 0x62, 0x74, 0x72, 0x74, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x25, 0x6F, 0xFB, 0x00, 0x25, 0x6F, 0xFB, 0x00, 0x00, 0x00, 0x10, 0x73, 0x74, 0x74,
        0x73, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x73, 0x74,
        0x73, 0x63, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x14, 0x73,
        0x74, 0x73, 0x7A, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x10, 0x73, 0x74, 0x63, 0x6F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x01, 0xC5, 0x74, 0x72, 0x61, 0x6B, 0x00, 0x00, 0x00, 0x5C, 0x74, 0x6B,
        0x68, 0x64, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x40,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x61,
        0x6D, 0x64, 0x69, 0x61, 0x00, 0x00, 0x00, 0x20, 0x6D, 0x64, 0x68, 0x64, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xBB, 0x80, 0x00, 0x00,
        0x00, 0x00, 0x55, 0xC4, 0x00, 0x00, 0x00, 0x00, 0x00, 0x36, 0x68, 0x64, 0x6C, 0x72, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x73, 0x6F, 0x75, 0x6E, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x4C, 0x2D, 0x53, 0x4D, 0x41, 0x53, 0x48,
        0x20, 0x41, 0x75, 0x64, 0x69, 0x6F, 0x20, 0x48, 0x61, 0x6E, 0x64, 0x6C, 0x65, 0x72, 0x00,
        0x00, 0x00, 0x01, 0x03, 0x6D, 0x69, 0x6E, 0x66, 0x00, 0x00, 0x00, 0x10, 0x73, 0x6D, 0x68,
        0x64, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x24, 0x64, 0x69,
        0x6E, 0x66, 0x00, 0x00, 0x00, 0x1C, 0x64, 0x72, 0x65, 0x66, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x0C, 0x75, 0x72, 0x6C, 0x20, 0x00, 0x00, 0x00, 0x01,
        0x00, 0x00, 0x00, 0xC7, 0x73, 0x74, 0x62, 0x6C, 0x00, 0x00, 0x00, 0x7B, 0x73, 0x74, 0x73,
        0x64, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x6B, 0x6D, 0x70,
        0x34, 0x61, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x10, 0x00, 0x00, 0x00, 0x00, 0xBB, 0x80, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x33, 0x65, 0x73, 0x64, 0x73, 0x00, 0x00, 0x00, 0x00, 0x03, 0x80, 0x80,
        0x80, 0x22, 0x00, 0x02, 0x00, 0x04, 0x80, 0x80, 0x80, 0x14, 0x40, 0x15, 0x00, 0x00, 0x00,
        0x00, 0x02, 0x71, 0x00, 0x00, 0x02, 0x71, 0x00, 0x05, 0x80, 0x80, 0x80, 0x02, 0x11, 0x90,
        0x06, 0x80, 0x80, 0x80, 0x01, 0x02, 0x00, 0x00, 0x00, 0x14, 0x62, 0x74, 0x72, 0x74, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x02, 0x71, 0x00, 0x00, 0x02, 0x71, 0x00, 0x00, 0x00, 0x00, 0x10,
        0x73, 0x74, 0x74, 0x73, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x10, 0x73, 0x74, 0x73, 0x63, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x14, 0x73, 0x74, 0x73, 0x7A, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x73, 0x74, 0x63, 0x6F, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x48, 0x6D, 0x76, 0x65, 0x78, 0x00, 0x00, 0x00,
        0x20, 0x74, 0x72, 0x65, 0x78, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00,
        0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x20, 0x74, 0x72, 0x65, 0x78, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02,
        0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x61, 0x75, 0x64, 0x74, 0x61, 0x00, 0x00, 0x00, 0x59, 0x73, 0x6B,
        0x69, 0x70, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x84, 0x6D, 0x6F, 0x6F,
        0x66, 0x00, 0x00, 0x00, 0x10, 0x6D, 0x66, 0x68, 0x64, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x01, 0x00, 0x00, 0x00, 0x6C, 0x74, 0x72, 0x61, 0x66, 0x00, 0x00, 0x00, 0x20, 0x74,
        0x66, 0x68, 0x64, 0x00, 0x02, 0x00, 0x3A, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01,
        0x00, 0x00, 0x02, 0x00, 0x00, 0x01, 0xFA, 0x65, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x14, 0x74, 0x66, 0x64, 0x74, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x30, 0x74, 0x72, 0x75, 0x6E, 0x01, 0x00, 0x0A, 0x05, 0x00,
        0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x8C, 0x02, 0x00, 0x00, 0x00, 0x00, 0x01, 0xFA, 0x65,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x57, 0x03, 0x00, 0x00, 0x06, 0x00, 0x00, 0x00, 0x0B,
        0xBD, 0x00, 0x00, 0x00, 0x00,
    ];

    let buf = &mut std::io::Cursor::new(&ENCODED);

    let ftyp = Ftyp::decode(buf).expect("failed to decode ftyp");

    assert_eq!(
        ftyp,
        Ftyp {
            major_brand: b"iso6".into(),
            minor_version: 512,
            compatible_brands: vec![b"iso6".into(), b"cmfc".into(), b"mp41".into()],
        }
    );

    let moov = Moov::decode(buf).expect("failed to decode moov");
    let expected = Moov {
        mvhd: Mvhd {
            creation_time: 0,
            modification_time: 0,
            timescale: 1000,
            duration: 0,
            rate: 1.into(),
            volume: 1.into(),
            matrix: Matrix {
                a: 65536,
                b: 0,
                u: 0,
                c: 0,
                d: 65536,
                v: 0,
                x: 0,
                y: 0,
                w: 1073741824,
            },
            next_track_id: 2,
        },
        meta: None,
        mvex: Some(Mvex {
            mehd: None,
            trex: vec![
                Trex {
                    track_id: 1,
                    default_sample_description_index: 1,
                    default_sample_duration: 0,
                    default_sample_size: 0,
                    default_sample_flags: 0,
                },
                Trex {
                    track_id: 2,
                    default_sample_description_index: 1,
                    default_sample_duration: 0,
                    default_sample_size: 0,
                    default_sample_flags: 0,
                },
            ],
        }),
        trak: vec![
            Trak {
                tkhd: Tkhd {
                    creation_time: 0,
                    modification_time: 0,
                    track_id: 1,
                    duration: 0,
                    layer: 0,
                    alternate_group: 0,
                    enabled: true,
                    volume: 0.into(),
                    matrix: Matrix {
                        a: 65536,
                        b: 0,
                        u: 0,
                        c: 0,
                        d: 65536,
                        v: 0,
                        x: 0,
                        y: 0,
                        w: 1073741824,
                    },
                    width: 1280.into(),
                    height: 720.into(),
                },
                edts: None,
                meta: None,
                mdia: Mdia {
                    mdhd: Mdhd {
                        creation_time: 0,
                        modification_time: 0,
                        timescale: 15360,
                        duration: 0,
                        language: "und".into(),
                    },
                    hdlr: Hdlr {
                        handler: b"vide".into(),
                        name: "L-SMASH Video Handler".to_string(),
                    },
                    minf: Minf {
                        vmhd: Some(Vmhd {
                            graphics_mode: 0,
                            op_color: RgbColor {
                                red: 0,
                                green: 0,
                                blue: 0,
                            },
                        }),
                        smhd: None,
                        dinf: Dinf {
                            dref: Dref {
                                urls: vec![Url::default()],
                            },
                        },
                        stbl: Stbl {
                            stsd: Stsd {
                                codecs: vec![Avc1 {
                                    visual: Visual {
                                        data_reference_index: 1,
                                        width: 1280,
                                        height: 720,
                                        horizresolution: 72.into(),
                                        vertresolution: 72.into(),
                                        frame_count: 1,
                                        compressor: "\nAVC Coding".into(),
                                        depth: 24,
                                    },
                                    avcc: Avcc {
                                        configuration_version: 1,
                                        avc_profile_indication: 100,
                                        profile_compatibility: 0,
                                        avc_level_indication: 31,
                                        length_size: 4,
                                        sequence_parameter_sets: vec![vec![
                                            103, 100, 0, 31, 172, 217, 128, 80, 5, 187, 1, 106, 2,
                                            2, 2, 128, 0, 0, 3, 0, 128, 0, 0, 30, 7, 140, 24, 205,
                                        ]],
                                        picture_parameter_sets: vec![vec![104, 233, 123, 44, 139]],
                                        ext: Some(AvccExt {
                                            chroma_format: 1,
                                            bit_depth_luma: 8,
                                            bit_depth_chroma: 8,
                                            sequence_parameter_sets_ext: vec![],
                                        }),
                                    },
                                    btrt: Some(Btrt {
                                        buffer_size_db: 0,
                                        max_bitrate: 2453499,
                                        avg_bitrate: 2453499,
                                    }),
                                    colr: Some(Colr::Nclx {
                                        colour_primaries: 1,
                                        transfer_characteristics: 1,
                                        matrix_coefficients: 1,
                                        full_range_flag: false,
                                    }),
                                    pasp: Some(Pasp {
                                        h_spacing: 1,
                                        v_spacing: 1,
                                    }),
                                    taic: None,
                                }
                                .into()],
                            },
                            stts: Stts::default(),
                            ctts: None,
                            stss: None,
                            stsc: Stsc::default(),
                            stsz: Stsz::default(),
                            stco: Some(Stco::default()),
                            co64: None,
                            saio: vec![],
                            saiz: vec![],
                        },
                    },
                },
            },
            Trak {
                tkhd: Tkhd {
                    creation_time: 0,
                    modification_time: 0,
                    track_id: 2,
                    duration: 0,
                    layer: 0,
                    alternate_group: 1,
                    enabled: true,
                    volume: 1.into(),
                    matrix: Matrix {
                        a: 65536,
                        b: 0,
                        u: 0,
                        c: 0,
                        d: 65536,
                        v: 0,
                        x: 0,
                        y: 0,
                        w: 1073741824,
                    },
                    width: 0.into(),
                    height: 0.into(),
                },
                edts: None,
                meta: None,
                mdia: Mdia {
                    mdhd: Mdhd {
                        creation_time: 0,
                        modification_time: 0,
                        timescale: 48000,
                        duration: 0,
                        language: "und".into(),
                    },
                    hdlr: Hdlr {
                        handler: b"soun".into(),
                        name: "L-SMASH Audio Handler".into(),
                    },
                    minf: Minf {
                        vmhd: None,
                        smhd: Some(Smhd::default()),
                        dinf: Dinf {
                            dref: Dref {
                                urls: vec![Url::default()],
                            },
                        },
                        stbl: Stbl {
                            stsd: Stsd {
                                codecs: vec![Mp4a {
                                    audio: Audio {
                                        data_reference_index: 1,
                                        channel_count: 2,
                                        sample_size: 16,
                                        sample_rate: 48000.into(),
                                    },
                                    esds: Esds {
                                        es_desc: esds::EsDescriptor {
                                            es_id: 2,
                                            dec_config: esds::DecoderConfig {
                                                object_type_indication: 64,
                                                stream_type: 5,
                                                up_stream: 0,
                                                buffer_size_db: u24::default(),
                                                max_bitrate: 160000,
                                                avg_bitrate: 160000,
                                                dec_specific: esds::DecoderSpecific {
                                                    profile: 2,
                                                    freq_index: 3,
                                                    chan_conf: 2,
                                                },
                                            },
                                            sl_config: esds::SLConfig::default(),
                                        },
                                    },
                                    btrt: Some(Btrt {
                                        buffer_size_db: 0,
                                        max_bitrate: 160000,
                                        avg_bitrate: 160000,
                                    }),
                                    taic: None,
                                }
                                .into()],
                            },
                            stts: Stts::default(),
                            ctts: None,
                            stss: None,
                            stsc: Stsc::default(),
                            stsz: Stsz::default(),
                            stco: Some(Stco::default()),
                            co64: None,
                            saio: vec![],
                            saiz: vec![],
                        },
                    },
                },
            },
        ],
        udta: Some(Udta {
            meta: None,
            skip: Some(Skip {
                zeroed: Zeroed { size: 81 },
            }),
        }),
    };

    assert_eq!(moov, expected, "different decoded result");

    // Make sure the avc1 atom encodes/decodes to the exact same content.
    let avc1 = &moov.trak[0].mdia.minf.stbl.stsd.codecs[0];
    avc1.assert_encode_decode();

    let mut buf = Vec::new();
    ftyp.encode(&mut buf).expect("failed to encode ftyp");
    moov.encode(&mut buf).expect("failed to encode moov");

    // assert_eq!(buf, ENCODED);
}

#[test]
fn avcc_ext_2() {
    const ENCODED: &[u8] = &[
        0x00, 0x00, 0x00, 0x1C, 0x66, 0x74, 0x79, 0x70, 0x69, 0x73, 0x6F, 0x36, 0x00, 0x00, 0x02,
        0x00, 0x69, 0x73, 0x6F, 0x36, 0x63, 0x6D, 0x66, 0x63, 0x6D, 0x70, 0x34, 0x31, 0x00, 0x00,
        0x02, 0xE0, 0x6D, 0x6F, 0x6F, 0x76, 0x00, 0x00, 0x00, 0x6C, 0x6D, 0x76, 0x68, 0x64, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0xE8,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x01, 0xE2, 0x74, 0x72,
        0x61, 0x6B, 0x00, 0x00, 0x00, 0x5C, 0x74, 0x6B, 0x68, 0x64, 0x00, 0x00, 0x00, 0x03, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x40, 0x00, 0x00, 0x00, 0x07, 0x80, 0x00, 0x00,
        0x04, 0x38, 0x00, 0x00, 0x00, 0x00, 0x01, 0x7E, 0x6D, 0x64, 0x69, 0x61, 0x00, 0x00, 0x00,
        0x20, 0x6D, 0x64, 0x68, 0x64, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x3C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x55, 0xC4, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x2D, 0x68, 0x64, 0x6C, 0x72, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x76, 0x69, 0x64, 0x65, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x56, 0x69, 0x64, 0x65, 0x6F, 0x48, 0x61, 0x6E, 0x64, 0x6C, 0x65, 0x72, 0x00, 0x00,
        0x00, 0x01, 0x29, 0x6D, 0x69, 0x6E, 0x66, 0x00, 0x00, 0x00, 0x14, 0x76, 0x6D, 0x68, 0x64,
        0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x24, 0x64, 0x69, 0x6E, 0x66, 0x00, 0x00, 0x00, 0x1C, 0x64, 0x72, 0x65, 0x66, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x0C, 0x75, 0x72, 0x6C, 0x20, 0x00,
        0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0xE9, 0x73, 0x74, 0x62, 0x6C, 0x00, 0x00, 0x00, 0x9D,
        0x73, 0x74, 0x73, 0x64, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
        0x8D, 0x61, 0x76, 0x63, 0x31, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07,
        0x80, 0x04, 0x38, 0x00, 0x48, 0x00, 0x00, 0x00, 0x48, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x01, 0x15, 0x4C, 0x61, 0x76, 0x63, 0x36, 0x30, 0x2E, 0x33, 0x31, 0x2E, 0x31, 0x30,
        0x32, 0x20, 0x6C, 0x69, 0x62, 0x78, 0x32, 0x36, 0x34, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x37, 0x61, 0x76, 0x63,
        0x43, 0x01, 0xF4, 0x00, 0x28, 0xFF, 0xE1, 0x00, 0x1A, 0x67, 0xF4, 0x00, 0x28, 0x91, 0x9B,
        0x28, 0x0F, 0x00, 0x44, 0xFC, 0x4C, 0x20, 0x00, 0x00, 0x03, 0x00, 0x20, 0x00, 0x00, 0x07,
        0x81, 0xE3, 0x06, 0x32, 0xC0, 0x01, 0x00, 0x06, 0x68, 0xEF, 0x8F, 0x19, 0x21, 0x90, 0xFF,
        0xF8, 0xF8, 0x00, 0x00, 0x00, 0x00, 0x10, 0x73, 0x74, 0x74, 0x73, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x73, 0x74, 0x73, 0x63, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x14, 0x73, 0x74, 0x73, 0x7A, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x73,
        0x74, 0x63, 0x6F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x28,
        0x6D, 0x76, 0x65, 0x78, 0x00, 0x00, 0x00, 0x20, 0x74, 0x72, 0x65, 0x78, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x62, 0x75, 0x64, 0x74, 0x61, 0x00,
        0x00, 0x00, 0x5A, 0x6D, 0x65, 0x74, 0x61, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x21,
        0x68, 0x64, 0x6C, 0x72, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x6D, 0x64, 0x69,
        0x72, 0x61, 0x70, 0x70, 0x6C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x2D, 0x69, 0x6C, 0x73, 0x74, 0x00, 0x00, 0x00, 0x25, 0xA9, 0x74, 0x6F, 0x6F,
        0x00, 0x00, 0x00, 0x1D, 0x64, 0x61, 0x74, 0x61, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
        0x00, 0x4C, 0x61, 0x76, 0x66, 0x36, 0x30, 0x2E, 0x31, 0x36, 0x2E, 0x31, 0x30, 0x30, 0x00,
        0x00, 0x00, 0x6C, 0x6D, 0x6F, 0x6F, 0x66, 0x00, 0x00, 0x00, 0x10, 0x6D, 0x66, 0x68, 0x64,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x54, 0x74, 0x72, 0x61,
        0x66, 0x00, 0x00, 0x00, 0x20, 0x74, 0x66, 0x68, 0x64, 0x00, 0x02, 0x00, 0x3A, 0x00, 0x00,
        0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x67, 0x1D, 0x01,
        0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x14, 0x74, 0x66, 0x64, 0x74, 0x01, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x74, 0x72, 0x75,
        0x6E, 0x01, 0x00, 0x00, 0x05, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x74, 0x02, 0x00,
        0x00,
    ];

    let buf = &mut std::io::Cursor::new(&ENCODED);

    let ftyp = Ftyp::decode(buf).expect("failed to decode ftyp");

    assert_eq!(
        ftyp,
        Ftyp {
            major_brand: b"iso6".into(),
            minor_version: 512,
            compatible_brands: vec![b"iso6".into(), b"cmfc".into(), b"mp41".into()],
        }
    );

    // This was failing because the avcc atom was under decoded.
    let _ = Moov::decode(buf).expect("failed to decode moov");
}

#[test]
fn avc_encrypted_segment() {
    // mdat + trun removed to reduce size.
    const ENCODED: &[u8] = &[
        0x00, 0x00, 0x00, 0x1C, 0x73, 0x74, 0x79, 0x70, 0x6D, 0x73, 0x64, 0x68, 0x00, 0x00, 0x00,
        0x00, 0x6D, 0x73, 0x69, 0x78, 0x6D, 0x73, 0x64, 0x68, 0x64, 0x61, 0x73, 0x68, 0x00, 0x00,
        0x00, 0x34, 0x73, 0x69, 0x64, 0x78, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00,
        0x98, 0x96, 0x80, 0x00, 0x01, 0x37, 0x3B, 0x2F, 0xE7, 0x63, 0x7D, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x20, 0x00, 0x00, 0x00, 0x01, 0x00, 0x05, 0x44, 0xEF, 0x04, 0xA7, 0x60,
        0x30, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x20, 0x70, 0x72, 0x66, 0x74, 0x01, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0xEC, 0x1D, 0x77, 0x39, 0x7C, 0xBA, 0xB1, 0x41, 0x00,
        0x01, 0x37, 0x3B, 0x2F, 0xE7, 0x63, 0x7D, 0x00, 0x00, 0x07, 0xD9, 0x6D, 0x6F, 0x6F, 0x66,
        0x00, 0x00, 0x00, 0x10, 0x6D, 0x66, 0x68, 0x64, 0x00, 0x00, 0x00, 0x00, 0x00, 0x42, 0xDF,
        0xFB, 0x00, 0x00, 0x07, 0xC1, 0x74, 0x72, 0x61, 0x66, 0x00, 0x00, 0x00, 0x10, 0x74, 0x66,
        0x68, 0x64, 0x00, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x14, 0x74,
        0x66, 0x64, 0x74, 0x01, 0x00, 0x00, 0x00, 0x00, 0x01, 0x37, 0x3B, 0x2F, 0xE7, 0x63, 0x7D,
        0x00, 0x00, 0x00, 0x19, 0x73, 0x61, 0x69, 0x7A, 0x00, 0x00, 0x00, 0x01, 0x63, 0x62, 0x63,
        0x73, 0x00, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00, 0xEA, 0x00, 0x00, 0x00, 0x1C, 0x73,
        0x61, 0x69, 0x6F, 0x00, 0x00, 0x00, 0x01, 0x63, 0x62, 0x63, 0x73, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x0F, 0x3D, 0x00, 0x00, 0x07, 0x60, 0x73, 0x65, 0x6E,
        0x63, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0xEA, 0x00, 0x01, 0x00, 0x81, 0x00, 0x00,
        0x2E, 0x26, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x02, 0x30, 0x00, 0x01, 0x00, 0x72, 0x00,
        0x00, 0x04, 0x51, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x03, 0xEE, 0x00, 0x01, 0x00, 0x72,
        0x00, 0x00, 0x03, 0xD6, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x04, 0x81, 0x00, 0x01, 0x00,
        0x72, 0x00, 0x00, 0x03, 0xDB, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x05, 0x40, 0x00, 0x01,
        0x00, 0x72, 0x00, 0x00, 0x05, 0x47, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x04, 0xCB, 0x00,
        0x01, 0x00, 0x72, 0x00, 0x00, 0x05, 0xB6, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x05, 0x0A,
        0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x05, 0x32, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x04,
        0x71, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x03, 0x69, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00,
        0x03, 0x8A, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x03, 0x6B, 0x00, 0x01, 0x00, 0x72, 0x00,
        0x00, 0x02, 0xE3, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x03, 0x55, 0x00, 0x01, 0x00, 0x72,
        0x00, 0x00, 0x04, 0x06, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x04, 0x69, 0x00, 0x01, 0x00,
        0x72, 0x00, 0x00, 0x04, 0x1A, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x05, 0x20, 0x00, 0x01,
        0x00, 0x72, 0x00, 0x00, 0x06, 0x18, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x05, 0xC1, 0x00,
        0x01, 0x00, 0x72, 0x00, 0x00, 0x05, 0x49, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x04, 0xB3,
        0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x04, 0xF9, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x04,
        0xD7, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x06, 0x4F, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00,
        0x04, 0x89, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x04, 0x83, 0x00, 0x01, 0x00, 0x72, 0x00,
        0x00, 0x04, 0x7E, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x04, 0x57, 0x00, 0x01, 0x00, 0x72,
        0x00, 0x00, 0x04, 0xA4, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x05, 0x4B, 0x00, 0x01, 0x00,
        0x72, 0x00, 0x00, 0x04, 0x60, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x04, 0x61, 0x00, 0x01,
        0x00, 0x72, 0x00, 0x00, 0x04, 0x7B, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x03, 0xFB, 0x00,
        0x01, 0x00, 0x72, 0x00, 0x00, 0x05, 0x33, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x04, 0x04,
        0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x06, 0x5B, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x03,
        0x53, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x04, 0x5C, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00,
        0x05, 0x2F, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x04, 0xB9, 0x00, 0x01, 0x00, 0x72, 0x00,
        0x00, 0x06, 0x3F, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x04, 0x28, 0x00, 0x01, 0x00, 0x72,
        0x00, 0x00, 0x05, 0x50, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x05, 0x7C, 0x00, 0x01, 0x00,
        0x72, 0x00, 0x00, 0x04, 0xEC, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x04, 0x49, 0x00, 0x01,
        0x00, 0x72, 0x00, 0x00, 0x04, 0xF0, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x05, 0x71, 0x00,
        0x01, 0x00, 0x72, 0x00, 0x00, 0x03, 0xB7, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x02, 0xE5,
        0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x03, 0x40, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x03,
        0x4D, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x03, 0xA1, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00,
        0x03, 0x27, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x04, 0x2A, 0x00, 0x01, 0x00, 0x72, 0x00,
        0x00, 0x03, 0xE5, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x03, 0xB4, 0x00, 0x01, 0x00, 0x72,
        0x00, 0x00, 0x04, 0x1B, 0x00, 0x01, 0x00, 0x80, 0x00, 0x00, 0x11, 0x5F, 0x00, 0x01, 0x00,
        0x75, 0x00, 0x00, 0x04, 0xC9, 0x00, 0x01, 0x00, 0x77, 0x00, 0x00, 0x03, 0x8C, 0x00, 0x01,
        0x00, 0x78, 0x00, 0x00, 0x04, 0xCD, 0x00, 0x01, 0x00, 0x79, 0x00, 0x00, 0x03, 0x96, 0x00,
        0x01, 0x00, 0x78, 0x00, 0x00, 0x03, 0xBB, 0x00, 0x01, 0x00, 0x78, 0x00, 0x00, 0x03, 0x72,
        0x00, 0x01, 0x00, 0x77, 0x00, 0x00, 0x03, 0xD0, 0x00, 0x01, 0x00, 0x78, 0x00, 0x00, 0x04,
        0xFB, 0x00, 0x01, 0x00, 0x78, 0x00, 0x00, 0x03, 0x89, 0x00, 0x01, 0x00, 0x77, 0x00, 0x00,
        0x03, 0x78, 0x00, 0x01, 0x00, 0x78, 0x00, 0x00, 0x04, 0x89, 0x00, 0x01, 0x00, 0x79, 0x00,
        0x00, 0x03, 0x0F, 0x00, 0x01, 0x00, 0x73, 0x00, 0x00, 0x03, 0x7D, 0x00, 0x01, 0x00, 0x78,
        0x00, 0x00, 0x03, 0x7A, 0x00, 0x01, 0x00, 0x77, 0x00, 0x00, 0x03, 0x38, 0x00, 0x01, 0x00,
        0x77, 0x00, 0x00, 0x05, 0xA9, 0x00, 0x01, 0x00, 0x77, 0x00, 0x00, 0x03, 0xD2, 0x00, 0x01,
        0x00, 0x78, 0x00, 0x00, 0x03, 0xC3, 0x00, 0x01, 0x00, 0x78, 0x00, 0x00, 0x06, 0x1F, 0x00,
        0x01, 0x00, 0x77, 0x00, 0x00, 0x04, 0xDE, 0x00, 0x01, 0x00, 0x78, 0x00, 0x00, 0x04, 0x1D,
        0x00, 0x01, 0x00, 0x77, 0x00, 0x00, 0x04, 0x51, 0x00, 0x01, 0x00, 0x73, 0x00, 0x00, 0x03,
        0x65, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x02, 0x89, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00,
        0x02, 0xA9, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x03, 0x62, 0x00, 0x01, 0x00, 0x72, 0x00,
        0x00, 0x02, 0xEA, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x02, 0xEE, 0x00, 0x01, 0x00, 0x72,
        0x00, 0x00, 0x03, 0xD3, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x02, 0xE8, 0x00, 0x01, 0x00,
        0x72, 0x00, 0x00, 0x04, 0x28, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x02, 0x96, 0x00, 0x01,
        0x00, 0x72, 0x00, 0x00, 0x02, 0xCD, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x03, 0x23, 0x00,
        0x01, 0x00, 0x72, 0x00, 0x00, 0x04, 0x06, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x03, 0x94,
        0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x03, 0x7A, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x03,
        0xCD, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x04, 0xD7, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00,
        0x03, 0x2E, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x04, 0xE4, 0x00, 0x01, 0x00, 0x72, 0x00,
        0x00, 0x04, 0x1D, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x04, 0xB2, 0x00, 0x01, 0x00, 0x72,
        0x00, 0x00, 0x04, 0x7A, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x04, 0x8A, 0x00, 0x01, 0x00,
        0x72, 0x00, 0x00, 0x04, 0x67, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x04, 0x86, 0x00, 0x01,
        0x00, 0x72, 0x00, 0x00, 0x05, 0x0F, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x03, 0xBF, 0x00,
        0x01, 0x00, 0x72, 0x00, 0x00, 0x05, 0x48, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x03, 0xCC,
        0x00, 0x01, 0x00, 0x81, 0x00, 0x00, 0x18, 0x6C, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x02,
        0x3A, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x03, 0x0C, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00,
        0x03, 0xAE, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x03, 0xD1, 0x00, 0x01, 0x00, 0x72, 0x00,
        0x00, 0x03, 0x24, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x03, 0xA5, 0x00, 0x01, 0x00, 0x72,
        0x00, 0x00, 0x03, 0xAF, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x03, 0xC5, 0x00, 0x01, 0x00,
        0x72, 0x00, 0x00, 0x03, 0x36, 0x00, 0x01, 0x00, 0x7F, 0x00, 0x00, 0x25, 0xAE, 0x00, 0x01,
        0x00, 0x72, 0x00, 0x00, 0x06, 0x0D, 0x00, 0x01, 0x00, 0x73, 0x00, 0x00, 0x06, 0x8C, 0x00,
        0x01, 0x00, 0x73, 0x00, 0x00, 0x06, 0x83, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x08, 0xDD,
        0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x07, 0x42, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x05,
        0x77, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x05, 0x5C, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00,
        0x05, 0x27, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x04, 0x50, 0x00, 0x01, 0x00, 0x72, 0x00,
        0x00, 0x04, 0x67, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x06, 0x54, 0x00, 0x01, 0x00, 0x72,
        0x00, 0x00, 0x04, 0xEB, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x04, 0xF6, 0x00, 0x01, 0x00,
        0x72, 0x00, 0x00, 0x05, 0xF9, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x05, 0x49, 0x00, 0x01,
        0x00, 0x72, 0x00, 0x00, 0x04, 0xA0, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x05, 0x47, 0x00,
        0x01, 0x00, 0x72, 0x00, 0x00, 0x04, 0xB3, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x06, 0x2A,
        0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x05, 0xD4, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x05,
        0x67, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x05, 0xD0, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00,
        0x06, 0x25, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x06, 0xA2, 0x00, 0x01, 0x00, 0x72, 0x00,
        0x00, 0x05, 0x1A, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x06, 0xA3, 0x00, 0x01, 0x00, 0x72,
        0x00, 0x00, 0x06, 0x4B, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x05, 0x8A, 0x00, 0x01, 0x00,
        0x72, 0x00, 0x00, 0x06, 0xEB, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x05, 0xF1, 0x00, 0x01,
        0x00, 0x72, 0x00, 0x00, 0x05, 0x1E, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x05, 0xD8, 0x00,
        0x01, 0x00, 0x72, 0x00, 0x00, 0x05, 0x74, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x04, 0x9C,
        0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x06, 0x81, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x03,
        0xEE, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x04, 0x22, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00,
        0x04, 0xE2, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x05, 0x38, 0x00, 0x01, 0x00, 0x72, 0x00,
        0x00, 0x05, 0x35, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x06, 0x23, 0x00, 0x01, 0x00, 0x72,
        0x00, 0x00, 0x06, 0xBE, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x05, 0x14, 0x00, 0x01, 0x00,
        0x72, 0x00, 0x00, 0x07, 0x49, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x08, 0xD8, 0x00, 0x01,
        0x00, 0x72, 0x00, 0x00, 0x05, 0xA3, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x05, 0x4A, 0x00,
        0x01, 0x00, 0x72, 0x00, 0x00, 0x05, 0x73, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x05, 0x7D,
        0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x06, 0x85, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x05,
        0x59, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x05, 0x81, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00,
        0x05, 0x3E, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x05, 0x40, 0x00, 0x01, 0x00, 0x72, 0x00,
        0x00, 0x04, 0xFC, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x05, 0x2F, 0x00, 0x01, 0x00, 0x72,
        0x00, 0x00, 0x05, 0x04, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x05, 0x1B, 0x00, 0x01, 0x00,
        0x72, 0x00, 0x00, 0x04, 0xFA, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x05, 0x56, 0x00, 0x01,
        0x00, 0x72, 0x00, 0x00, 0x04, 0xE4, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x05, 0x04, 0x00,
        0x01, 0x00, 0x72, 0x00, 0x00, 0x04, 0xE7, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x04, 0xF2,
        0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x05, 0x1D, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x04,
        0xE9, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x04, 0xB4, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00,
        0x04, 0xFA, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x04, 0x0F, 0x00, 0x01, 0x00, 0x72, 0x00,
        0x00, 0x04, 0x6E, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x04, 0xDE, 0x00, 0x01, 0x00, 0x72,
        0x00, 0x00, 0x04, 0x35, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x05, 0x45, 0x00, 0x01, 0x00,
        0x72, 0x00, 0x00, 0x05, 0x44, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x05, 0x45, 0x00, 0x01,
        0x00, 0x72, 0x00, 0x00, 0x05, 0x31, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x05, 0x09, 0x00,
        0x01, 0x00, 0x72, 0x00, 0x00, 0x04, 0x59, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x04, 0xD6,
        0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x05, 0x5A, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x05,
        0x98, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x05, 0xAF, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00,
        0x05, 0x76, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x05, 0x8A, 0x00, 0x01, 0x00, 0x72, 0x00,
        0x00, 0x05, 0x46, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x05, 0x7D, 0x00, 0x01, 0x00, 0x72,
        0x00, 0x00, 0x05, 0x06, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x04, 0xFF, 0x00, 0x01, 0x00,
        0x72, 0x00, 0x00, 0x04, 0xB4, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x05, 0x6B, 0x00, 0x01,
        0x00, 0x72, 0x00, 0x00, 0x05, 0xE4, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x07, 0xE2, 0x00,
        0x01, 0x00, 0x72, 0x00, 0x00, 0x06, 0x14, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x05, 0x58,
        0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x05, 0xEA, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x05,
        0x54, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x05, 0x0F, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00,
        0x04, 0xD9, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x06, 0x46, 0x00, 0x01, 0x00, 0x72, 0x00,
        0x00, 0x05, 0x66, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x04, 0xD9, 0x00, 0x01, 0x00, 0x72,
        0x00, 0x00, 0x06, 0x0D, 0x00, 0x01, 0x00, 0x72, 0x00, 0x00, 0x05, 0xA1, 0x00, 0x01, 0x00,
        0x72, 0x00, 0x00, 0x06, 0x03, 0x00, 0x01, 0x00, 0x77, 0x00, 0x00, 0x06, 0x3C, 0x00, 0x01,
        0x00, 0x72, 0x00, 0x00, 0x03, 0x3B,
    ];

    let buf = &mut std::io::Cursor::new(&ENCODED);

    let styp = match Any::decode(buf) {
        Ok(Any::Styp(styp)) => styp,
        Ok(atom) => panic!("unexpected {} while decoding any styp", atom.kind()),
        Err(e) => panic!("failed to decode styp with error: {e}"),
    };
    assert_eq!(
        styp,
        Styp {
            major_brand: b"msdh".into(),
            minor_version: 0,
            compatible_brands: vec![b"msix".into(), b"msdh".into(), b"dash".into()]
        }
    );

    let sidx = match Any::decode(buf) {
        Ok(Any::Unknown(kind, bytes)) => (kind, bytes),
        Ok(atom) => panic!("unexpected {} while decoding any sidx", atom.kind()),
        Err(e) => panic!("failed to decode sidx with error: {e}"),
    };
    assert_eq!(FourCC::from(b"sidx"), sidx.0);
    assert_eq!(&ENCODED[36..80], &sidx.1);

    let prft = match Any::decode(buf) {
        Ok(Any::Unknown(kind, bytes)) => (kind, bytes),
        Ok(atom) => panic!("unexpected {} while decoding any prft", atom.kind()),
        Err(e) => panic!("failed to decode prft with error: {e}"),
    };
    assert_eq!(FourCC::from(b"prft"), prft.0);
    assert_eq!(&ENCODED[88..112], &prft.1);

    let moof = match Any::decode(buf) {
        Ok(Any::Moof(moof)) => moof,
        Ok(atom) => panic!("unexpected {} while decoding any moof", atom.kind()),
        Err(e) => panic!("failed to decode moof with error: {e}"),
    };
    assert_eq!(
        moof,
        Moof {
            mfhd: Mfhd {
                sequence_number: 4382715
            },
            traf: vec![Traf {
                tfhd: Tfhd {
                    track_id: 1,
                    base_data_offset: None,
                    sample_description_index: None,
                    default_sample_duration: None,
                    default_sample_size: None,
                    default_sample_flags: None,
                },
                tfdt: Some(Tfdt {
                    base_media_decode_time: 342202323002237
                }),
                trun: vec![],
                saiz: vec![Saiz {
                    aux_info: Some(AuxInfo {
                        aux_info_type: b"cbcs".into(),
                        aux_info_type_parameter: 0
                    }),
                    default_sample_info_size: 8,
                    sample_count: 234,
                    sample_info_size: vec![],
                }],
                saio: vec![Saio {
                    aux_info: Some(AuxInfo {
                        aux_info_type: b"cbcs".into(),
                        aux_info_type_parameter: 0
                    }),
                    offsets: vec![3901],
                }],
                meta: None,
                udta: None,
            }]
        }
    );

    assert_eq!(0, buf.remaining());
}
